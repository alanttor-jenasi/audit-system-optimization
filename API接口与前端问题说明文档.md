# QA审核系统 - API接口与前端问题说明文档

## 📋 目录
1. [后端接口说明](#后端接口说明)
2. [前端功能与问题](#前端功能与问题)
3. [数据流程说明](#数据流程说明)
4. [已知问题与建议](#已知问题与建议)

---

## 🔌 后端接口说明

### 1. 未审核区域接口

#### 1.1 获取未审核分段列表
- **接口路径**: `GET /api/unreviewed/segments`
- **功能**: 获取未审核知识库中所有文档的分段数据
- **返回数据**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": "分段ID",
        "content": "原始内容",
        "question": "解析后的问题",
        "answer": "解析后的答案",
        "document_id": "文档ID",
        "document_name": "文档名称",
        "add_method": "添加方式（旧QA/微信每日QA/人工添加/用户添加）",
        "add_source": "添加来源",
        "classification": "分类",
        "created_at": 时间戳
      }
    ],
    "total": 总条数
  }
  ```
- **特点**:
  - 自动遍历所有未审核文档（旧QA、微信每日QA、人工/用户添加）
  - 自动解析QA内容，提取问题、答案、来源等信息
  - 按创建时间降序排列

---

### 2. 已审核区域接口

#### 2.1 获取已审核文档列表
- **接口路径**: `GET /api/reviewed/documents`
- **功能**: 获取所有已审核文档分类列表
- **返回数据**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": "文档ID",
        "name": "文档名称（如：接线类、电机类等）"
      }
    ]
  }
  ```

#### 2.2 获取文档分类列表
- **接口路径**: `GET /api/document-categories`
- **功能**: 获取所有文档分类（用于下拉选择）
- **返回数据**:
  ```json
  {
    "success": true,
    "categories": [
      {
        "id": "文档ID",
        "name": "文档名称"
      }
    ],
    "total": 分类总数
  }
  ```

#### 2.3 获取指定文档的分段列表
- **接口路径**: `GET /api/reviewed/segments/<document_id>`
- **功能**: 获取已审核区域中指定文档的所有分段
- **返回数据**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": "分段ID",
        "content": "原始内容",
        "question": "解析后的问题",
        "answer": "解析后的答案",
        "document_id": "文档ID",
        "document_name": "文档名称",
        "updated_at": 时间戳
      }
    ],
    "total": 总条数
  }
  ```
- **特点**: 按更新时间降序排列

---

### 3. 分段操作接口

#### 3.1 更新分段内容
- **接口路径**: `POST /api/segment/update`
- **功能**: 更新分段的问题和答案
- **请求参数**:
  ```json
  {
    "dataset_id": "知识库ID",
    "document_id": "文档ID",
    "segment_id": "分段ID",
    "question": "新问题",
    "answer": "新答案"
  }
  ```
- **特点**:
  - 自动保留原有的元数据（source、add_type等）
  - 自动生成关键词（使用问题的前50个字符）

#### 3.2 删除分段
- **接口路径**: `POST /api/segment/delete`
- **功能**: 删除指定的分段
- **请求参数**:
  ```json
  {
    "dataset_id": "知识库ID",
    "document_id": "文档ID",
    "segment_id": "分段ID"
  }
  ```

#### 3.3 审核通过（转移分段）
- **接口路径**: `POST /api/segment/approve`
- **功能**: 将未审核分段转移到已审核知识库的指定文档
- **请求参数**:
  ```json
  {
    "source_document_id": "源文档ID（未审核）",
    "segment_id": "分段ID",
    "target_document_id": "目标文档ID（已审核）",
    "question": "问题（可能已编辑）",
    "answer": "答案（可能已编辑）"
  }
  ```
- **处理流程**:
  1. 从源文档获取原分段内容
  2. 解析并保留元数据（source、add_type）
  3. 在目标文档中添加新分段
  4. 删除源文档中的原分段
  5. 记录审核统计
- **返回数据**:
  ```json
  {
    "success": true,
    "message": "已转移到 {目标文档名称}"
  }
  ```

---

### 4. 统计接口

#### 4.1 获取今日审核统计
- **接口路径**: `GET /api/stats/today`
- **功能**: 获取今日审核通过的条数
- **返回数据**:
  ```json
  {
    "success": true,
    "count": 今日审核条数,
    "date": "2025-01-15"
  }
  ```
- **数据存储**: SQLite数据库 (`approval_stats.db`)

#### 4.2 获取月度审核统计
- **接口路径**: `GET /api/stats/monthly?year=2025&month=1`
- **功能**: 获取指定月份的每日审核统计
- **返回数据**:
  ```json
  {
    "success": true,
    "stats": {
      "2025-01-01": 10,
      "2025-01-02": 15,
      ...
    },
    "year": 2025,
    "month": 1
  }
  ```

#### 4.3 获取已审核总数
- **接口路径**: `GET /api/stats/total-reviewed`
- **功能**: 获取已审核知识库的总条数（带缓存）
- **缓存机制**: 5分钟缓存，避免频繁计算
- **返回数据**:
  ```json
  {
    "success": true,
    "total": 总条数,
    "cached": true/false
  }
  ```

---

### 5. 查重接口

#### 5.1 查重功能
- **接口路径**: `POST /api/reviewed/check-duplicates`
- **功能**: 使用BGE模型 + 余弦相似度查找已审核区域中的重复QA
- **请求参数**:
  ```json
  {
    "similarity_threshold": 0.8  // 相似度阈值（0-1），默认0.8
  }
  ```
- **返回数据**:
  ```json
  {
    "success": true,
    "data": {
      "total_groups": 重复组数,
      "total_duplicates": 重复条目总数,
      "groups": [
        {
          "group_id": 组ID,
          "count": 组内条目数,
          "similarity": "平均相似度",
          "items": [
            {
              "segment_id": "分段ID",
              "document_id": "文档ID",
              "document_name": "文档名称",
              "classification": "分类",
              "question": "问题",
              "answer": "答案",
              "similarity": "相似度百分比",
              "updated_at": 时间戳
            }
          ]
        }
      ]
    }
  }
  ```
- **特点**:
  - 遍历所有已审核文档
  - 使用BGE模型进行语义相似度计算
  - 返回按组分类的重复项

---

## 🎨 前端功能与问题

### 1. 未审核区域功能

#### 1.1 数据加载
- **功能**: 页面加载时自动获取未审核分段列表
- **实现**: `loadUnreviewedData()`
- **问题**:
  - ⚠️ **数据量大时加载慢**: 一次性加载所有未审核数据，如果数据量很大（数千条），会导致首次加载时间过长
  - ⚠️ **无分页加载**: 虽然前端有分页显示，但后端返回的是全部数据，前端进行分页切片

#### 1.2 编辑追踪机制
- **功能**: 实时追踪用户对问题和答案的编辑
- **实现**: `syncEditToState()` 函数
- **特点**:
  - 使用 `Map` 存储编辑状态
  - 自动检测内容变化
  - 如果恢复原值，自动从编辑列表中移除
- **问题**:
  - ⚠️ **编辑未保存提示**: 用户编辑后如果直接切换页面或刷新，可能丢失编辑内容（虽然有自动保存机制，但可能不够明显）

#### 1.3 自动保存机制
- **功能**: 在分页切换时自动保存当前页的编辑
- **实现**: `saveCurrentPageEdits()`
- **触发时机**:
  - 切换分页时
  - 刷新页面时（通过确认弹窗）
- **问题**:
  - ⚠️ **保存失败处理**: 如果保存失败，用户可能不知道哪些编辑未保存成功
  - ⚠️ **批量保存性能**: 如果一页有多个编辑，会发起多个并发请求，可能对服务器造成压力

#### 1.4 分类选择功能
- **功能**: 点击分类标签可以选择文档分类
- **实现**: `showClassificationSelector()` 和 `updateSegmentClassification()`
- **问题**:
  - ⚠️ **分类未持久化**: 分类选择只更新前端显示和state，但**没有保存到后端**。这意味着：
    - 刷新页面后分类会丢失
    - 审核通过时使用的是前端选择的分类，但原分段中的分类字段可能没有更新
  - ⚠️ **分类验证**: 审核通过时检查分类，但如果分类为空或无效，提示可能不够明显

#### 1.5 审核通过流程
- **功能**: 点击"通过"按钮，将QA转移到已审核知识库
- **实现**: `handleApprove()` 和 `performApproval()`
- **流程**:
  1. 检查问题和答案是否为空
  2. 检查是否已选择分类
  3. 根据分类名称查找文档ID
  4. 调用审核接口
  5. 更新本地数据
  6. 刷新统计
- **问题**:
  - ⚠️ **分类选择依赖**: 必须选择分类才能审核，但分类选择器可能不够明显
  - ⚠️ **审核后数据同步**: 审核通过后，已审核总数需要重新计算（虽然有缓存，但可能不够及时）

---

### 2. 已审核区域功能

#### 2.1 文档选择界面
- **功能**: 显示所有已审核文档分类的卡片
- **实现**: `renderDocumentGrid()`
- **特点**:
  - 每个文档卡片显示图标和名称
  - 异步加载每个文档的分段条数
- **问题**:
  - ⚠️ **条数加载慢**: 每个文档都需要单独请求，如果文档很多，加载时间会很长
  - ⚠️ **条数不准确**: 条数是从已审核分段接口获取的，如果数据有更新，可能不准确

#### 2.2 文档详情界面
- **功能**: 显示指定文档的所有分段
- **实现**: `loadReviewedData()` 和 `renderReviewedList()`
- **问题**:
  - ⚠️ **无编辑追踪**: 已审核区域的编辑没有自动保存机制，需要手动点击"保存"按钮
  - ⚠️ **保存后刷新**: 保存成功后会重新加载整个列表，如果数据量大，体验不好

---

### 3. 统计功能

#### 3.1 今日统计
- **功能**: 显示今日审核通过的条数
- **实现**: `loadTodayStats()`
- **特点**: 点击可查看月度统计
- **问题**: 无

#### 3.2 月度统计
- **功能**: 以日历形式显示月度审核统计
- **实现**: `showMonthlyStatsModal()` 和 `renderCalendar()`
- **问题**: 无

#### 3.3 已审核总数
- **功能**: 显示已审核知识库的总条数
- **实现**: `loadReviewedTotal()`
- **问题**:
  - ⚠️ **缓存延迟**: 由于有5分钟缓存，新增数据后可能不会立即更新
  - ⚠️ **计算耗时**: 如果已审核数据量很大，计算总条数可能需要较长时间

---

### 4. 查重功能

#### 4.1 查重流程
- **功能**: 查找已审核区域中的重复QA
- **实现**: `handleCheckDuplicates()` 和 `performDuplicateCheck()`
- **流程**:
  1. 显示查重弹窗
  2. 显示加载动画
  3. 调用后端查重接口
  4. 渲染查重结果
- **问题**:
  - ⚠️ **查重耗时**: 如果已审核数据量很大，查重可能需要1-2分钟，用户体验不好
  - ⚠️ **结果展示**: 查重结果以组的形式展示，但如果重复组很多，页面可能很长
  - ⚠️ **删除后刷新**: 删除重复项后需要重新查重，如果数据量大，会再次等待很长时间

#### 4.2 重复项操作
- **功能**: 编辑或删除查重结果中的重复项
- **实现**: `editDuplicateItem()` 和 `deleteDuplicateItem()`
- **问题**:
  - ⚠️ **删除接口错误**: `deleteDuplicateItem()` 函数中使用的删除接口路径不正确：
    ```javascript
    // 当前代码（错误）
    fetch(`${API_BASE}/api/reviewed/segments/${segmentId}`, {
      method: 'DELETE',
      ...
    })
    
    // 应该是
    fetch(`${API_BASE}/api/segment/delete`, {
      method: 'POST',
      ...
    })
    ```
  - ⚠️ **编辑跳转**: 点击编辑后跳转到已审核区域，但如果该分段不在当前显示的文档中，可能找不到

---

### 5. 其他功能

#### 5.1 主题切换
- **功能**: 支持明暗主题切换
- **实现**: `toggleTheme()`
- **特点**: 使用 localStorage 保存主题设置
- **问题**: 无

#### 5.2 刷新确认
- **功能**: 拦截F5和Ctrl+R刷新，显示确认弹窗
- **实现**: `handleRefreshRequest()` 和 `handleBeforeUnload()`
- **问题**:
  - ⚠️ **刷新逻辑**: 确认刷新后只是回到首页，而不是真正的浏览器刷新，可能导致数据不更新

#### 5.3 分页功能
- **功能**: 支持分页浏览和跳转
- **实现**: `changePage()` 和 `jumpToPage()`
- **问题**:
  - ⚠️ **分页是前端分页**: 所有数据都在前端，分页只是前端切片，如果数据量很大，内存占用会很高

---

## 🔄 数据流程说明

### 未审核 → 已审核流程

```
1. 用户打开未审核区域
   ↓
2. 前端调用 GET /api/unreviewed/segments
   ↓
3. 后端遍历所有未审核文档，获取分段并解析
   ↓
4. 前端显示列表，用户可以选择分类、编辑内容
   ↓
5. 用户点击"通过"按钮
   ↓
6. 前端检查分类是否已选择
   ↓
7. 前端调用 POST /api/segment/approve
   ↓
8. 后端：
   - 获取原分段内容
   - 解析并保留元数据
   - 在目标文档中添加新分段
   - 删除源文档中的原分段
   - 记录审核统计
   ↓
9. 前端更新本地数据，刷新统计
```

### 编辑保存流程

```
1. 用户在未审核区域编辑问题和答案
   ↓
2. 前端实时追踪编辑（syncEditToState）
   ↓
3. 用户切换分页或刷新
   ↓
4. 前端自动保存当前页的编辑（saveCurrentPageEdits）
   ↓
5. 批量调用 POST /api/segment/update
   ↓
6. 后端更新分段内容，保留元数据
   ↓
7. 前端更新本地数据
```

---

## ⚠️ 已知问题与建议

### 严重问题

1. **分类未持久化**
   - **问题**: 分类选择只更新前端，没有保存到后端
   - **影响**: 刷新页面后分类丢失
   - **建议**: 
     - 在分类选择时调用更新接口，将分类保存到分段内容中
     - 或者在审核通过时，将分类信息写入分段内容

2. **查重删除接口错误**
   - **问题**: `deleteDuplicateItem()` 使用了错误的接口路径
   - **影响**: 删除重复项功能无法正常工作
   - **建议**: 修改为使用 `POST /api/segment/delete` 接口

3. **数据量大时性能问题**
   - **问题**: 一次性加载所有数据，前端分页
   - **影响**: 
     - 首次加载慢
     - 内存占用高
     - 用户体验差
   - **建议**: 
     - 后端支持分页查询
     - 前端实现真正的分页加载

### 中等问题

4. **编辑保存失败处理**
   - **问题**: 批量保存时，部分失败可能不够明显
   - **建议**: 显示详细的保存结果，列出失败的项目

5. **已审核条数不准确**
   - **问题**: 文档卡片上的条数可能不准确
   - **建议**: 定期刷新或使用WebSocket实时更新

6. **查重耗时过长**
   - **问题**: 数据量大时查重需要1-2分钟
   - **建议**: 
     - 显示进度条
     - 支持后台查重，完成后通知
     - 优化查重算法

### 优化建议

7. **添加编辑状态提示**
   - 在卡片上显示"已编辑"标识
   - 在页面离开时提示未保存的编辑

8. **优化加载体验**
   - 使用骨架屏替代加载动画
   - 实现增量加载

9. **添加操作历史**
   - 记录用户的审核、编辑、删除操作
   - 支持撤销功能

10. **优化查重结果展示**
    - 支持折叠/展开重复组
    - 支持批量删除重复项
    - 支持导出查重结果

---

## 📝 总结

### 接口设计
- ✅ 接口设计合理，功能完整
- ✅ 错误处理完善
- ✅ 支持元数据保留

### 前端实现
- ✅ 功能基本完整
- ⚠️ 存在一些性能和体验问题
- ⚠️ 部分功能实现不够完善（如分类持久化）

### 建议优先级
1. **高优先级**: 修复查重删除接口错误、实现分类持久化
2. **中优先级**: 优化大数据量加载、改进编辑保存机制
3. **低优先级**: 添加操作历史、优化UI体验

---

**文档生成时间**: 2025-01-15
**系统版本**: v1.0

